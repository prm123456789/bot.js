// inconnu/inconnuTech/deploy.js
import { spawn } from "child_process";
import path from "path";
import fs from "fs/promises";
import config from "../../config.cjs";

const deployCommand = async (m, sock) => {
  const prefix = config.PREFIX;
  const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(" ")[0].toLowerCase() : "";
  const text = m.body.slice(prefix.length + cmd.length).trim();

  if (cmd === "deploy") {
    if (m.sender !== config.OWNER_NUMBER + "@s.whatsapp.net") {
      await sock.sendMessage(
        m.from,
        { text: "❌ *ONLY OWNER CAN DEPLOY NEW BOTS!*" },
        { quoted: m }
      );
      return;
    }

    if (!text) {
      await sock.sendMessage(
        m.from,
        { text: "❌ Provide the SESSION_ID to deploy.\n\nExample:\n.deploy INCONNU~XD~fileid#key" },
        { quoted: m }
      );
      return;
    }

    const timestamp = Date.now();
    const sessionDir = path.resolve(`session-${timestamp}`);
    await fs.mkdir(sessionDir, { recursive: true });

    await sock.sendMessage(
      m.from,
      { text: "⏳ *WAIT FOR YOUR BOT TO DEPLOY...*" },
      { quoted: m }
    );

    const envContent = `SESSION_ID=${text}
PREFIX=.
PORT=${4000 + Math.floor(Math.random() * 5000)}
MODE=public
OWNER_NUMBER=${config.OWNER_NUMBER}
`;
    await fs.writeFile(path.join(sessionDir, ".env"), envContent);

    const child = spawn(
      "node",
      ["../multiBot.js"],
      {
        cwd: sessionDir,
        stdio: "inherit",
        env: { ...process.env, NODE_ENV: "production" }
      }
    );

    await sock.sendMessage(
      m.from,
      { text: "✅ *BOT CONNECTÉ AVEC SUCCÈS!*" },
      { quoted: m }
    );
  }
};

export default deployCommand;
